version: 2
models:
  - name: defi__fact_tcy_unstake_events
    description: "Comprehensive fact table tracking THORchain Yield (TCY) unstaking events and withdrawal transactions. This table captures detailed information about users withdrawing their staked assets from TCY pools including transaction IDs, unstaked amounts, RUNE addresses, memo fields, and precise timing information. Essential for calculating actual yield earned by users, understanding user exit patterns and behaviors, measuring pool retention rates, and analyzing the lifecycle of TCY staking positions. Each record represents a unique TCY unstaking transaction with complete user and transaction metadata for thorough yield farming analysis, liquidity flow tracking, and protocol performance monitoring."
    columns:
      - name: FACT_TCY_UNSTAKE_EVENTS_ID
        description: "{{ doc('sk') }}"
        tests:
          - dbt_expectations.expect_column_to_exist
          - unique
      - name: BLOCK_TIMESTAMP
        description: "{{ doc('block_timestamp') }}"
        tests:
          - not_null:
              where: DIM_BLOCK_ID not in ('-1','-2')
      - name: DIM_BLOCK_ID
        description: "FK to DIM_BLOCK table"
        tests:
          - negative_one:
              where: _inserted_timestamp <  (CURRENT_TIMESTAMP - INTERVAL '8 HOURS')
      - name: TX_ID
        description: "{{ doc('tx_id') }}"
        tests:
          - not_null
      - name: AMOUNT
        description: "The amount"
        tests:
          - not_null
      - name: RUNE_ADDRESS
        description: "{{ doc('address') }}"
        tests:
          - not_null
      - name: MEMO
        description: "{{ doc('memo') }}"
      - name: EVENT_ID
        description: "{{ doc('id') }}"
        tests:
          - not_null
      - name: INSERTED_TIMESTAMP
        description: '{{ doc("inserted_timestamp") }}'   
      - name: MODIFIED_TIMESTAMP
        description: '{{ doc("modified_timestamp") }}'  
    tests:
      - dbt_constraints.primary_key:
          column_name: FACT_TCY_UNSTAKE_EVENTS_ID
      - dbt_constraints.foreign_key:
          fk_column_name: DIM_BLOCK_ID
          pk_table_name: ref('core__dim_block')
          pk_column_name: DIM_BLOCK_ID
